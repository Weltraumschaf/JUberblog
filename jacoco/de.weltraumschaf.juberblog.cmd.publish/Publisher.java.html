<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Publisher.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JUberblog</a> &gt; <a href="index.html" class="el_package">de.weltraumschaf.juberblog.cmd.publish</a> &gt; <span class="el_source">Publisher.java</span></div><h1>Publisher.java</h1><pre class="source lang-java linenums">/*
 *  LICENSE
 *
 * &quot;THE BEER-WARE LICENSE&quot; (Revision 43):
 * &quot;Sven Strittmatter&quot; &lt;weltraumschaf@googlemail.com&gt; wrote this file.
 * As long as you retain this notice you can do whatever you want with
 * this stuff. If we meet some day, and you think this stuff is worth it,
 * you can buy me a non alcohol-free beer in return.
 *
 * Copyright (C) 2012 &quot;Sven Strittmatter&quot; &lt;weltraumschaf@googlemail.com&gt;
 */
package de.weltraumschaf.juberblog.cmd.publish;

import de.weltraumschaf.commons.ApplicationException;
import de.weltraumschaf.commons.guava.Lists;
import de.weltraumschaf.juberblog.Constants;
import de.weltraumschaf.juberblog.Directories;
import de.weltraumschaf.juberblog.ExitCodeImpl;
import de.weltraumschaf.juberblog.files.FilenameFilters;
import de.weltraumschaf.juberblog.formatter.Formatters;
import de.weltraumschaf.juberblog.model.DataFile;
import de.weltraumschaf.juberblog.model.Page;
import freemarker.template.Configuration;
import freemarker.template.TemplateException;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.net.URI;
import java.net.URISyntaxException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.StandardOpenOption;
import java.util.Collection;
import java.util.List;
import org.apache.commons.io.IOUtils;
import org.apache.commons.lang3.Validate;
import org.apache.log4j.Logger;
import org.joda.time.DateTime;

/**
 *
 * @author Sven Strittmatter &lt;weltraumschaf@googlemail.com&gt;
 */
class Publisher implements Command {

    /**
     * Log facility.
     */
<span class="fc" id="L49">    private static final Logger LOG = Logger.getLogger(Publisher.class);</span>
    private final Directories dirs;
    private final Configuration templateConfig;
    private final String baseUri;
    private boolean sites;
    private boolean purge;
    private boolean dataRead;
    private Collection&lt;DataFile&gt; sitesData;
    private Collection&lt;DataFile&gt; postsData;

    public Publisher(final Directories dirs, final Configuration templateConfig, final String baseUri) {
<span class="fc" id="L60">        super();</span>
<span class="fc" id="L61">        this.dirs = dirs;</span>
<span class="fc" id="L62">        this.templateConfig = templateConfig;</span>
<span class="fc" id="L63">        this.baseUri = baseUri;</span>
<span class="fc" id="L64">    }</span>

    void readData() {
<span class="fc" id="L67">        List&lt;DataFile&gt; files = Lists.newArrayList();</span>

<span class="fc bfc" id="L69" title="All 2 branches covered.">        for (final File f : dirs.dataSites().toFile().listFiles(FilenameFilters.findMarkdownFiles())) {</span>
<span class="fc" id="L70">            files.add(new DataFile(f));</span>
        }

<span class="fc" id="L73">        sitesData = files;</span>
<span class="fc" id="L74">        files = Lists.newArrayList();</span>

<span class="fc bfc" id="L76" title="All 2 branches covered.">        for (final File f : dirs.dataPosts().toFile().listFiles(FilenameFilters.findMarkdownFiles())) {</span>
<span class="fc" id="L77">            files.add(new DataFile(f));</span>
        }

<span class="fc" id="L80">        postsData = files;</span>
<span class="fc" id="L81">        dataRead = true;</span>
<span class="fc" id="L82">    }</span>

    Collection&lt;DataFile&gt; getSitesData() {
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">        if (!dataRead) {</span>
<span class="nc" id="L86">            throw new IllegalStateException(&quot;Data never read! Invoke #readData() at least once.&quot;);</span>
        }

<span class="fc" id="L89">        return sitesData;</span>
    }

    Collection&lt;DataFile&gt; getPostsData() {
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">        if (!dataRead) {</span>
<span class="nc" id="L94">            throw new IllegalStateException(&quot;Data never read! Invoke #readData() at least once.&quot;);</span>
        }

<span class="fc" id="L97">        return postsData;</span>
    }

    @Override
    public void execute() throws ApplicationException {
<span class="fc" id="L102">        readData();</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        final List&lt;Page&gt; publishedSites = isSites() ? publishSites() : Lists.&lt;Page&gt;newArrayList();</span>

<span class="fc" id="L105">        final List&lt;Page&gt; publishedPosts = publisPosts();</span>
<span class="fc" id="L106">        updateIndexes(publishedSites, publishedPosts);</span>
<span class="fc" id="L107">    }</span>

    public void setSites(boolean sites) {
<span class="nc" id="L110">        this.sites = sites;</span>
<span class="nc" id="L111">    }</span>

    private boolean isSites() {
<span class="fc" id="L114">        return sites;</span>
    }

    public void setPurga(boolean purga) {
<span class="nc" id="L118">        this.purge = purga;</span>
<span class="nc" id="L119">    }</span>

    private boolean isPurge() {
<span class="nc" id="L122">        return purge;</span>
    }

    private List&lt;Page&gt; publishSites() throws ApplicationException {
<span class="nc" id="L126">        LOG.info(&quot;Publish sites...&quot;);</span>
<span class="nc" id="L127">        return publishFiles(</span>
                Formatters.Type.SITE,
                getSitesData(),
                dirs.htdocsSites());
    }

    private List&lt;Page&gt; publisPosts() throws ApplicationException {
<span class="fc" id="L134">        LOG.info(&quot;Publish posts...&quot;);</span>
<span class="fc" id="L135">        return publishFiles(</span>
                Formatters.Type.POST,
                getPostsData(),
                dirs.htdocsPosts());
    }

    private void updateIndexes(final List&lt;Page&gt; sites, final List&lt;Page&gt; posts) {
<span class="fc" id="L142">        updateHomeSite();</span>
<span class="fc" id="L143">        updateSiteMap();</span>
<span class="fc" id="L144">        updateFeed();</span>
<span class="fc" id="L145">    }</span>

    /**
     * Publish all files in given directory with given layout.
     *
     * @param type must not be {@literal null}
     * @param data must not be {@literal null}
     * @param outputDir must not be {@literal null}
     * @throws ApplicationException if can't render template
     */
    private List&lt;Page&gt; publishFiles(final Formatters.Type type, final Collection&lt;DataFile&gt; data, final Path outputDir)
            throws ApplicationException {
<span class="fc" id="L157">        Validate.notNull(type, &quot;Layout must not be null!&quot;);</span>
<span class="fc" id="L158">        Validate.notNull(data, &quot;Dirname must not be null!&quot;);</span>
<span class="fc" id="L159">        Validate.notNull(outputDir, &quot;Output dir must not be null!&quot;);</span>
<span class="fc" id="L160">        LOG.debug(String.format(&quot;Pubish files from '%s'...&quot;, data));</span>
<span class="fc" id="L161">        final List&lt;Page&gt; published = Lists.newArrayList();</span>

<span class="fc bfc" id="L163" title="All 2 branches covered.">        for (final DataFile file : data) {</span>
<span class="fc" id="L164">            published.add(publishFile(type, file, outputDir));</span>
<span class="fc" id="L165">        }</span>

<span class="fc" id="L167">        return published;</span>
    }

    /**
     * Publish a given file with a given layout.
     *
     * @param type must not be {@literal null}
     * @param file must not be {@literal null} or empty
     * @param outputDir must not be {@literal null}
     * @throws ApplicationException if can't render template
     */
    private Page publishFile(final Formatters.Type type, final DataFile data, final Path outputDir)
            throws ApplicationException {
<span class="fc" id="L180">        Validate.notNull(type, &quot;Layout must not be null!&quot;);</span>
<span class="fc" id="L181">        Validate.notNull(data, &quot;File name must not be null or empty!&quot;);</span>
<span class="fc" id="L182">        Validate.notNull(outputDir, &quot;Output dir must not be null!&quot;);</span>
<span class="fc" id="L183">        final String targetFileName = data.getSlug() + &quot;.html&quot;;</span>
<span class="fc" id="L184">        LOG.info(String.format(&quot;Publishing file '%s'...&quot;, targetFileName));</span>
<span class="fc" id="L185">        final Path target = outputDir.resolve(targetFileName);</span>

<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        if (publishedFileExists(target.toFile())) {</span>
<span class="nc" id="L188">            LOG.info(String.format(&quot;File %s already exists.&quot;, target));</span>

<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (isPurge()) {</span>
<span class="nc" id="L191">                LOG.info(&quot;Purge option is true. File will be republished.&quot;);</span>
            } else {
<span class="nc" id="L193">                LOG.info(&quot;Skip file.&quot;);</span>
                try {
<span class="nc" id="L195">                    return Page.newExistingPage(&quot;title&quot;, new URI(&quot;&quot;), &quot;description&quot;, new DateTime());</span>
<span class="nc" id="L196">                } catch (URISyntaxException ex) {</span>
<span class="nc" id="L197">                    throw new ApplicationException(ExitCodeImpl.FATAL, ex.getMessage(), ex);</span>
                }
            }
        }

<span class="fc" id="L202">        FileInputStream input = null;</span>

        try {
<span class="pc bpc" id="L205" title="3 of 4 branches missed.">            if (type == Formatters.Type.POST || type == Formatters.Type.SITE) {</span>
<span class="fc" id="L206">                input = new FileInputStream(new File(data.getFilename()));</span>
<span class="fc" id="L207">                final DataProcessor processor = new DataProcessor(</span>
                        input,
                        type,
                        baseUri,
                        templateConfig);

<span class="fc" id="L213">                LOG.info(String.format(&quot;Write published file to '%s'.&quot;, target));</span>
<span class="fc" id="L214">                Files.createFile(target);</span>
<span class="fc" id="L215">                Files.write(</span>
                        target,
                        processor.getHtml().getBytes(Constants.DEFAULT_ENCODING.toString()),
                        StandardOpenOption.WRITE);
            }
<span class="nc" id="L220">        } catch (final IOException | TemplateException ex) {</span>
<span class="nc" id="L221">            throw new ApplicationException(</span>
                    ExitCodeImpl.FATAL,
                    String.format(&quot;Error occured during publishing: %s!&quot;, ex.getMessage()),
                    ex);
        } finally {
<span class="pc" id="L226">            IOUtils.closeQuietly(input);</span>
<span class="fc" id="L227">        }</span>

        try {
<span class="fc" id="L230">            return Page.newPublishedPage(&quot;title&quot;, new URI(&quot;&quot;), &quot;description&quot;, new DateTime());</span>
<span class="nc" id="L231">        } catch (URISyntaxException ex) {</span>
<span class="nc" id="L232">            throw new ApplicationException(ExitCodeImpl.FATAL, ex.getMessage(), ex);</span>
        }
    }

    /**
     * Checks if a file to be published already exists.
     *
     * @param file must not be {@literal null}
     * @return {@literal true} if file already exists, else {@literal false}
     */
    boolean publishedFileExists(final File file) {
<span class="fc" id="L243">        return file.exists();</span>
    }

    private void updateHomeSite() {
<span class="fc" id="L247">        LOG.info(&quot;Update home site...&quot;);</span>
<span class="fc" id="L248">        new HomeSiteGenerator().execute();</span>
<span class="fc" id="L249">    }</span>

    private void updateSiteMap() {
<span class="fc" id="L252">        LOG.info(&quot;Update site map...&quot;);</span>
<span class="fc" id="L253">        new SiteMapGenerator(templateConfig).execute();</span>
<span class="fc" id="L254">    }</span>

    private void updateFeed() {
<span class="fc" id="L257">        LOG.info(&quot;Update feed...&quot;);</span>
//        new FeedGenerator(templateConfig).execute();
<span class="fc" id="L259">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>