<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JUberblog.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JUberblog</a> &gt; <a href="index.source.html" class="el_package">de.weltraumschaf.juberblog</a> &gt; <span class="el_source">JUberblog.java</span></div><h1>JUberblog.java</h1><pre class="source lang-java linenums">package de.weltraumschaf.juberblog;

import de.weltraumschaf.commons.application.ApplicationException;
import de.weltraumschaf.commons.application.IO;
import de.weltraumschaf.commons.application.Version;
import de.weltraumschaf.commons.validate.Validate;
import de.weltraumschaf.freemarkerdown.FreeMarkerDown;

import de.weltraumschaf.juberblog.core.BlogConfiguration;
import de.weltraumschaf.juberblog.core.Constants;
import de.weltraumschaf.juberblog.core.Directories;
import de.weltraumschaf.juberblog.core.ExitCodeImpl;
import de.weltraumschaf.juberblog.core.Templates;
import de.weltraumschaf.juberblog.core.Verbose;
import de.weltraumschaf.juberblog.options.Options;
import de.weltraumschaf.juberblog.options.OptionsWithConfig;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

/**
 * Registry object to cary around important objects.
 *
 * @since 1.0.0
 * @author Sven Strittmatter
 */
public final class JUberblog implements Registry {

    /**
     * Holds important directories.
     */
    private Directories dirs;
    /**
     * Holds the needed templates.
     */
    private Templates tpls;
    /**
     * Holds the blog's configuration.
     */
    private BlogConfiguration cfg;
    /**
     * Holds the command line options.
     */
    private Options opt;
    /**
     * Provides I/O for the command line.
     */
    private IO io;
    private Version version;
    private FreeMarkerDown fmd;
    private Verbose verbose;

    /**
     * Use {@link Builder} instead.
     */
    private JUberblog() {
<span class="fc" id="L58">        super();</span>
<span class="fc" id="L59">    }</span>

    /**
     * Copies the whole object.
     *
     * @return never {@code nul}, always new instance
     */
    private JUberblog copy() {
<span class="fc" id="L67">        final JUberblog copy = new JUberblog();</span>
<span class="fc" id="L68">        copy.cfg = cfg;</span>
<span class="fc" id="L69">        copy.dirs = dirs;</span>
<span class="fc" id="L70">        copy.io = io;</span>
<span class="fc" id="L71">        copy.opt = opt;</span>
<span class="fc" id="L72">        copy.tpls = tpls;</span>
<span class="fc" id="L73">        copy.version = version;</span>
<span class="fc" id="L74">        copy.fmd = fmd;</span>
<span class="fc" id="L75">        copy.verbose = verbose;</span>
<span class="fc" id="L76">        return copy;</span>
    }

    @Override
    public Directories directories() {
<span class="fc" id="L81">        return dirs;</span>
    }

    @Override
    public Templates templates() {
<span class="fc" id="L86">        return tpls;</span>
    }

    @Override
    public BlogConfiguration configuration() {
<span class="fc" id="L91">        return cfg;</span>
    }

    @Override
    public Options options() {
<span class="fc" id="L96">        return opt;</span>
    }

    @Override
    public IO io() {
<span class="fc" id="L101">        return io;</span>
    }

    @Override
    public Version version() {
<span class="fc" id="L106">        return version;</span>
    }

    @Override
    public FreeMarkerDown fmd() {
<span class="fc" id="L111">        return fmd;</span>
    }

    @Override
    public Verbose verbose() {
<span class="fc" id="L116">        return verbose;</span>
    }

    /**
     * Creates filled registry, but without loading configuration from file.
     *
     * @param cliOptions must not be {@code null}
     * @param io must not be {@code null}
     * @return never {@code null}
     * @throws ApplicationException if not all objects can't be generated
     */
    public static JUberblog generateWithDefaultConfig(final Options cliOptions, final IO io) throws ApplicationException {
<span class="fc" id="L128">        return generate(cliOptions, io, BlogConfiguration.DEFAULT);</span>
    }

    /**
     * Creates filled registry with a given configuration.
     *
     * @param cliOptions must not be {@code null}
     * @param io must not be {@code null}
     * @param configuration must not be {@code null}
     * @return never {@code null}
     * @throws ApplicationException if not all objects can't be generated
     */
    public static JUberblog generate(final Options cliOptions, final IO io, final BlogConfiguration configuration) throws ApplicationException {
<span class="fc" id="L141">        final Path dataDir = findDataDir(configuration);</span>
<span class="fc" id="L142">        final Path outputDir = findOutputDir(configuration);</span>
<span class="fc" id="L143">        final Path templateDir = findTemplateDir(configuration);</span>
<span class="fc" id="L144">        final FreeMarkerDown fmd = FreeMarkerDown.create(configuration.getEncoding());</span>
<span class="fc" id="L145">        final Verbose verbose = new Verbose(cliOptions.isVerbose(), io.getStdout());</span>
<span class="fc" id="L146">        final Version version = new Version(Constants.PACKAGE_BASE.toString() + &quot;/version.properties&quot;);</span>

        try {
<span class="fc" id="L149">            version.load();</span>
<span class="nc" id="L150">        } catch (IOException ex) {</span>
<span class="nc" id="L151">            throw new ApplicationException(ExitCodeImpl.FATAL, &quot;Can't load version properties!&quot;, ex);</span>
<span class="fc" id="L152">        }</span>

<span class="fc" id="L154">        return JUberblog.Builder.create()</span>
<span class="fc" id="L155">            .directories(createDirs(dataDir, outputDir))</span>
<span class="fc" id="L156">            .templates(createTemplate(templateDir))</span>
<span class="fc" id="L157">            .configuration(configuration)</span>
<span class="fc" id="L158">            .options(cliOptions)</span>
<span class="fc" id="L159">            .io(io)</span>
<span class="fc" id="L160">            .fmd(fmd)</span>
<span class="fc" id="L161">            .verbose(verbose)</span>
<span class="fc" id="L162">            .version(version)</span>
<span class="fc" id="L163">            .product();</span>
    }

    /**
     * Finds template directory based on location of blog.
     *
     * @param configuration must not be {@code null}
     * @return never {@code null}
     */
    private static Path findTemplateDir(final BlogConfiguration configuration) {
<span class="fc" id="L173">        return Paths.get(configuration.getTemplateDir());</span>
    }

    /**
     * Finds output directory based on location of blog.
     *
     * @param configuration must not be {@code null}
     * @return never {@code null}
     */
    private static Path findOutputDir(final BlogConfiguration configuration) {
<span class="fc" id="L183">        return Paths.get(configuration.getHtdocs());</span>
    }

    /**
     * Finds data directory based on location of blog.
     *
     * @param configuration must not be {@code null}
     * @return never {@code null}
     */
    private static Path findDataDir(final BlogConfiguration configuration) {
<span class="fc" id="L193">        return Paths.get(configuration.getDataDir());</span>
    }

    /**
     * Creates template directory object.
     *
     * @param templateDir must not be {@code null}
     * @return never {@code null}
     */
    private static Templates createTemplate(final Path templateDir) {
<span class="fc" id="L203">        return new Templates(</span>
<span class="fc" id="L204">            templateDir.resolve(&quot;layout.ftl&quot;),</span>
<span class="fc" id="L205">            templateDir.resolve(&quot;post.ftl&quot;),</span>
<span class="fc" id="L206">            templateDir.resolve(&quot;site.ftl&quot;),</span>
<span class="fc" id="L207">            templateDir.resolve(&quot;feed.ftl&quot;),</span>
<span class="fc" id="L208">            templateDir.resolve(&quot;index.ftl&quot;),</span>
<span class="fc" id="L209">            templateDir.resolve(&quot;site_map.ftl&quot;),</span>
<span class="fc" id="L210">            templateDir.resolve(&quot;create/post_or_site.md.ftl&quot;));</span>
    }

    /**
     * Creates directories object.
     *
     * @param dataDir must not be {@code null}
     * @param outputDir must not be {@code null}
     * @return never {@code null}
     */
    private static Directories createDirs(final Path dataDir, final Path outputDir) {
<span class="fc" id="L221">        return new Directories(dataDir, outputDir);</span>
    }

    /**
     * Loads the configuration from given CLI option.
     *
     * @param cliOptions must not be {@code null}
     * @return never {@code null}, always new instance
     * @throws ApplicationException if file can't be loaded
     */
    public static BlogConfiguration generateConfiguration(final OptionsWithConfig cliOptions) throws ApplicationException {
<span class="fc" id="L232">        final Path configFile = Paths.get(Validate.notNull(cliOptions, &quot;cliOptions&quot;).getConfig());</span>

<span class="pc bpc" id="L234" title="1 of 2 branches missed.">        if (!Files.isRegularFile(configFile)) {</span>
<span class="nc" id="L235">            throw new ApplicationException(</span>
                ExitCodeImpl.FATAL,
<span class="nc" id="L237">                String.format(&quot;Can't read config file '%s'!&quot;, cliOptions.getConfig()));</span>
        }

        final BlogConfiguration configuration;

        try {
<span class="fc" id="L243">            configuration = new BlogConfiguration(configFile.toString());</span>
<span class="nc" id="L244">        } catch (final IOException ex) {</span>
<span class="nc" id="L245">            throw new ApplicationException(</span>
                ExitCodeImpl.FATAL,
<span class="nc" id="L247">                String.format(&quot;Error during read of config file '%s'!&quot;, cliOptions.getConfig()));</span>
<span class="fc" id="L248">        }</span>

<span class="fc" id="L250">        return configuration;</span>
    }

    /**
     * Builder for less constructor parameters.
     */
    public static final class Builder {

        /**
         * Holds the build values.
         */
<span class="fc" id="L261">        private final JUberblog holder = new JUberblog();</span>

        /**
         * Use {@link #create()} instead.
         */
        private Builder() {
<span class="fc" id="L267">            super();</span>
<span class="fc" id="L268">        }</span>

        /**
         * Creates builder.
         *
         * @return never {@code null}, always new instance
         */
        public static Builder create() {
<span class="fc" id="L276">            return new Builder();</span>
        }

        /**
         * Get the directories.
         *
         * @param dirs must not be {@code null}
         * @return never {@code null}
         */
        public Builder directories(final Directories dirs) {
<span class="fc" id="L286">            holder.dirs = Validate.notNull(dirs, &quot;dirs&quot;);</span>
<span class="fc" id="L287">            return this;</span>
        }

        /**
         * Get the templates.
         *
         * @param tpls must not be {@code null}
         * @return never {@code null}
         */
        public Builder templates(final Templates tpls) {
<span class="fc" id="L297">            holder.tpls = Validate.notNull(tpls, &quot;tpls&quot;);</span>
<span class="fc" id="L298">            return this;</span>
        }

        /**
         * Get the configuration.
         *
         * @param cfg must not be {@code null}
         * @return never {@code null}
         */
        public Builder configuration(final BlogConfiguration cfg) {
<span class="fc" id="L308">            holder.cfg = Validate.notNull(cfg, &quot;cfg&quot;);</span>
<span class="fc" id="L309">            return this;</span>
        }

        /**
         * Get the options.
         *
         * @param opt must not be {@code null}
         * @return never {@code null}
         */
        public Builder options(final Options opt) {
<span class="fc" id="L319">            holder.opt = Validate.notNull(opt, &quot;opt&quot;);</span>
<span class="fc" id="L320">            return this;</span>
        }

        /**
         * Get the I/O.
         *
         * @param io must not be {@code null}
         * @return never {@code null}
         */
        public Builder io(final IO io) {
<span class="fc" id="L330">            holder.io = Validate.notNull(io, &quot;io&quot;);</span>
<span class="fc" id="L331">            return this;</span>
        }

        public Builder verbose(final Verbose verbose) {
<span class="fc" id="L335">            holder.verbose = Validate.notNull(verbose, &quot;verbose&quot;);</span>
<span class="fc" id="L336">            return this;</span>
        }

        public Builder fmd(final FreeMarkerDown fmd) {
<span class="fc" id="L340">            holder.fmd = Validate.notNull(fmd, &quot;fmd&quot;);</span>
<span class="fc" id="L341">            return this;</span>
        }

        public Builder version(final Version version) {
<span class="fc" id="L345">            holder.version = Validate.notNull(version, &quot;version&quot;);</span>
<span class="fc" id="L346">            return this;</span>
        }

        /**
         * Creates the final product.
         *
         * @return never {@code null}, always new instance
         */
        public JUberblog product() {
<span class="fc" id="L355">            return validate(holder.copy());</span>
        }

        /**
         * Validates that all fields are not {@code null}.
         *
         * @param product must not be {@code null}
         * @return the validated object itself
         */
        private JUberblog validate(final JUberblog product) {
<span class="fc" id="L365">            Validate.notNull(product, &quot;product&quot;);</span>
<span class="fc" id="L366">            notNull(product.cfg, &quot;Configuration must not be null! Call Builder#configuration(cfg) first.&quot;);</span>
<span class="fc" id="L367">            notNull(product.dirs, &quot;Directories must not be null! Call Builder#directories(dirs) first.&quot;);</span>
<span class="fc" id="L368">            notNull(product.io, &quot;I/O must not be null! Call Builder#io(io) first.&quot;);</span>
<span class="fc" id="L369">            notNull(product.opt, &quot;Options must not be null! Call Builder#options(opt) first.&quot;);</span>
<span class="fc" id="L370">            notNull(product.tpls, &quot;Templates must not be null! Call Builder#templates(tpls) first.&quot;);</span>
<span class="fc" id="L371">            return product;</span>
        }

        /**
         * Throws {@link NullPointerException} if passed in object is {@code null}.
         *
         * @param o may be {@code null}
         * @param msg the exception message
         */
        private void notNull(final Object o, final String msg) {
<span class="fc bfc" id="L381" title="All 2 branches covered.">            if (null == o) {</span>
<span class="fc" id="L382">                throw new NullPointerException(msg);</span>
            }
<span class="fc" id="L384">        }</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>