<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JUberblog.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JUberblog</a> &gt; <a href="index.source.html" class="el_package">de.weltraumschaf.juberblog</a> &gt; <span class="el_source">JUberblog.java</span></div><h1>JUberblog.java</h1><pre class="source lang-java linenums">package de.weltraumschaf.juberblog;

import de.weltraumschaf.commons.application.ApplicationException;
import de.weltraumschaf.commons.application.IO;
import de.weltraumschaf.commons.application.Version;
import de.weltraumschaf.commons.validate.Validate;
import de.weltraumschaf.freemarkerdown.FreeMarkerDown;

import de.weltraumschaf.juberblog.core.BlogConfiguration;
import de.weltraumschaf.juberblog.core.Constants;
import de.weltraumschaf.juberblog.core.Directories;
import de.weltraumschaf.juberblog.core.ExitCodeImpl;
import de.weltraumschaf.juberblog.core.Templates;
import de.weltraumschaf.juberblog.core.Verbose;
import de.weltraumschaf.juberblog.options.InstallOptions;
import de.weltraumschaf.juberblog.options.Options;
import de.weltraumschaf.juberblog.options.OptionsWithConfig;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

/**
 * Registry object to cary around important objects.
 *
 * @since 1.0.0
 * @author Sven Strittmatter
 */
public final class JUberblog implements Registry {

    /**
     * Holds important directories.
     */
    private Directories dirs;
    /**
     * Holds the needed templates.
     */
    private Templates tpls;
    /**
     * Holds the blog's configuration.
     */
    private BlogConfiguration cfg;
    /**
     * Holds the command line options.
     */
    private Options opt;
    /**
     * Provides I/O for the command line.
     */
    private IO io;
    private Version version;
    private FreeMarkerDown fmd;
    private Verbose verbose;

    /**
     * Use {@link Builder} instead.
     */
    private JUberblog() {
<span class="fc" id="L59">        super();</span>
<span class="fc" id="L60">    }</span>

    /**
     * Copies the whole object.
     *
     * @return never {@code nul}, always new instance
     */
    private JUberblog copy() {
<span class="fc" id="L68">        final JUberblog copy = new JUberblog();</span>
<span class="fc" id="L69">        copy.cfg = cfg;</span>
<span class="fc" id="L70">        copy.dirs = dirs;</span>
<span class="fc" id="L71">        copy.io = io;</span>
<span class="fc" id="L72">        copy.opt = opt;</span>
<span class="fc" id="L73">        copy.tpls = tpls;</span>
<span class="fc" id="L74">        copy.version = version;</span>
<span class="fc" id="L75">        copy.fmd = fmd;</span>
<span class="fc" id="L76">        copy.verbose = verbose;</span>
<span class="fc" id="L77">        return copy;</span>
    }

    @Override
    public Directories directories() {
<span class="fc" id="L82">        return dirs;</span>
    }

    @Override
    public Templates templates() {
<span class="fc" id="L87">        return tpls;</span>
    }

    @Override
    public BlogConfiguration configuration() {
<span class="fc" id="L92">        return cfg;</span>
    }

    @Override
    public Options options() {
<span class="fc" id="L97">        return opt;</span>
    }

    @Override
    public IO io() {
<span class="fc" id="L102">        return io;</span>
    }

    @Override
    public Version version() {
<span class="fc" id="L107">        return version;</span>
    }

    @Override
    public FreeMarkerDown fmd() {
<span class="fc" id="L112">        return fmd;</span>
    }

    @Override
    public Verbose verbose() {
<span class="fc" id="L117">        return verbose;</span>
    }

    /**
     * Creates filled registry, but without loading configuration from file.
     *
     * @param cliOptions must not be {@code null}
     * @param io must not be {@code null}
     * @return never {@code null}
     * @throws ApplicationException if not all objects can't be generated
     */
    public static JUberblog generateWithDefaultConfig(final Options cliOptions, final IO io) throws ApplicationException {
<span class="fc" id="L129">        return generate(cliOptions, io, BlogConfiguration.DEFAULT);</span>
    }

    /**
     * Creates filled registry with a given configuration.
     *
     * @param cliOptions must not be {@code null}
     * @param io must not be {@code null}
     * @param configuration must not be {@code null}
     * @return never {@code null}
     * @throws ApplicationException if not all objects can't be generated
     */
    public static JUberblog generate(final Options cliOptions, final IO io, final BlogConfiguration configuration) throws ApplicationException {
<span class="fc" id="L142">        final Path dataDir = findDataDir(configuration);</span>
<span class="fc" id="L143">        final Path outputDir = findOutputDir(configuration);</span>
<span class="fc" id="L144">        final Path templateDir = findTemplateDir(configuration);</span>
<span class="fc" id="L145">        final FreeMarkerDown fmd = FreeMarkerDown.create(configuration.getEncoding());</span>
<span class="fc" id="L146">        final Verbose verbose = new Verbose(cliOptions.isVerbose(), io.getStdout());</span>
<span class="fc" id="L147">        final Version version = new Version(Constants.PACKAGE_BASE.toString() + &quot;/version.properties&quot;);</span>

        try {
<span class="fc" id="L150">            version.load();</span>
<span class="nc" id="L151">        } catch (IOException ex) {</span>
<span class="nc" id="L152">            throw new ApplicationException(ExitCodeImpl.FATAL, &quot;Can't load version properties!&quot;, ex);</span>
<span class="fc" id="L153">        }</span>

<span class="fc" id="L155">        return JUberblog.Builder.create()</span>
<span class="fc" id="L156">            .directories(createDirs(dataDir, outputDir))</span>
<span class="fc" id="L157">            .templates(createTemplate(templateDir))</span>
<span class="fc" id="L158">            .configuration(configuration)</span>
<span class="fc" id="L159">            .options(cliOptions)</span>
<span class="fc" id="L160">            .io(io)</span>
<span class="fc" id="L161">            .fmd(fmd)</span>
<span class="fc" id="L162">            .verbose(verbose)</span>
<span class="fc" id="L163">            .version(version)</span>
<span class="fc" id="L164">            .product();</span>
    }

    /**
     * Finds template directory based on location of blog.
     *
     * @param locationDir must not be {@code null}
     * @param configuration must not be {@code null}
     * @return never {@code null}
     */
    private static Path findTemplateDir(final BlogConfiguration configuration) {
<span class="fc" id="L175">        return Paths.get(configuration.getTemplateDir());</span>
    }

    /**
     * Finds output directory based on location of blog.
     *
     * @param locationDir must not be {@code null}
     * @param configuration must not be {@code null}
     * @return never {@code null}
     */
    private static Path findOutputDir(final BlogConfiguration configuration) {
<span class="fc" id="L186">        return Paths.get(configuration.getHtdocs());</span>
    }

    /**
     * Finds data directory based on location of blog.
     *
     * @param locationDir must not be {@code null}
     * @param configuration must not be {@code null}
     * @return never {@code null}
     */
    private static Path findDataDir(final BlogConfiguration configuration) {
<span class="fc" id="L197">        return Paths.get(configuration.getDataDir());</span>
    }

    /**
     * Finds location directory of blog.
     *
     * @param cliOptions must not be {@code null}
     * @return never {@code null}
     * @throws ApplicationException if location is not a directory
     */
    private static Path findLocationDir(final InstallOptions cliOptions) throws ApplicationException {
<span class="nc" id="L208">        final Path locationDir = Paths.get(cliOptions.getLocation());</span>

<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (!Files.isDirectory(locationDir)) {</span>
<span class="nc" id="L211">            throw new ApplicationException(</span>
                ExitCodeImpl.FATAL,
<span class="nc" id="L213">                String.format(&quot;Given location '%s' is not a valid direcotry!&quot;, cliOptions.getLocation()));</span>
        }

<span class="nc" id="L216">        return locationDir;</span>
    }

    /**
     * Creates template directory object.
     *
     * @param templateDir must not be {@code null}
     * @return never {@code null}
     */
    private static Templates createTemplate(final Path templateDir) {
<span class="fc" id="L226">        return new Templates(</span>
<span class="fc" id="L227">            templateDir.resolve(&quot;layout.ftl&quot;),</span>
<span class="fc" id="L228">            templateDir.resolve(&quot;post.ftl&quot;),</span>
<span class="fc" id="L229">            templateDir.resolve(&quot;site.ftl&quot;),</span>
<span class="fc" id="L230">            templateDir.resolve(&quot;feed.ftl&quot;),</span>
<span class="fc" id="L231">            templateDir.resolve(&quot;index.ftl&quot;),</span>
<span class="fc" id="L232">            templateDir.resolve(&quot;site_map.ftl&quot;),</span>
<span class="fc" id="L233">            templateDir.resolve(&quot;create/post_or_site.md.ftl&quot;));</span>
    }

    /**
     * Creates directories object.
     *
     * @param dataDir must not be {@code null}
     * @param outputDir must not be {@code null}
     * @return never {@code null}
     */
    private static Directories createDirs(final Path dataDir, final Path outputDir) {
<span class="fc" id="L244">        return new Directories(dataDir, outputDir);</span>
    }

    /**
     * Loads the configuration from given CLI option.
     *
     * @param cliOptions must not be {@code null}
     * @return never {@code null}, always new instance
     * @throws ApplicationException if file can't be loaded
     */
    public static BlogConfiguration generateConfiguration(final OptionsWithConfig cliOptions) throws ApplicationException {
<span class="fc" id="L255">        final Path configFile = Paths.get(Validate.notNull(cliOptions, &quot;cliOptions&quot;).getConfig());</span>

<span class="pc bpc" id="L257" title="1 of 2 branches missed.">        if (!Files.isRegularFile(configFile)) {</span>
<span class="nc" id="L258">            throw new ApplicationException(</span>
                ExitCodeImpl.FATAL,
<span class="nc" id="L260">                String.format(&quot;Can't read config file '%s'!&quot;, cliOptions.getConfig()));</span>
        }

        final BlogConfiguration configuration;

        try {
<span class="fc" id="L266">            configuration = new BlogConfiguration(configFile.toString());</span>
<span class="nc" id="L267">        } catch (final IOException ex) {</span>
<span class="nc" id="L268">            throw new ApplicationException(</span>
                ExitCodeImpl.FATAL,
<span class="nc" id="L270">                String.format(&quot;Error during read of config file '%s'!&quot;, cliOptions.getConfig()));</span>
<span class="fc" id="L271">        }</span>

<span class="fc" id="L273">        return configuration;</span>
    }

    /**
     * Builder for less constructor parameters.
     */
    public static final class Builder {

        /**
         * Holds the build values.
         */
<span class="fc" id="L284">        private final JUberblog holder = new JUberblog();</span>

        /**
         * Use {@link #create()} instead.
         */
        private Builder() {
<span class="fc" id="L290">            super();</span>
<span class="fc" id="L291">        }</span>

        /**
         * Creates builder.
         *
         * @return never {@code null}, always new instance
         */
        public static Builder create() {
<span class="fc" id="L299">            return new Builder();</span>
        }

        /**
         * Get the directories.
         *
         * @param dirs must not be {@code null}
         * @return never {@code null}
         */
        public Builder directories(final Directories dirs) {
<span class="fc" id="L309">            holder.dirs = Validate.notNull(dirs, &quot;dirs&quot;);</span>
<span class="fc" id="L310">            return this;</span>
        }

        /**
         * Get the templates.
         *
         * @param tpls must not be {@code null}
         * @return never {@code null}
         */
        public Builder templates(final Templates tpls) {
<span class="fc" id="L320">            holder.tpls = Validate.notNull(tpls, &quot;tpls&quot;);</span>
<span class="fc" id="L321">            return this;</span>
        }

        /**
         * Get the configuration.
         *
         * @param cfg must not be {@code null}
         * @return never {@code null}
         */
        public Builder configuration(final BlogConfiguration cfg) {
<span class="fc" id="L331">            holder.cfg = Validate.notNull(cfg, &quot;cfg&quot;);</span>
<span class="fc" id="L332">            return this;</span>
        }

        /**
         * Get the options.
         *
         * @param opt must not be {@code null}
         * @return never {@code null}
         */
        public Builder options(final Options opt) {
<span class="fc" id="L342">            holder.opt = Validate.notNull(opt, &quot;opt&quot;);</span>
<span class="fc" id="L343">            return this;</span>
        }

        /**
         * Get the I/O.
         *
         * @param io must not be {@code null}
         * @return never {@code null}
         */
        public Builder io(final IO io) {
<span class="fc" id="L353">            holder.io = Validate.notNull(io, &quot;io&quot;);</span>
<span class="fc" id="L354">            return this;</span>
        }

        public Builder verbose(final Verbose verbose) {
<span class="fc" id="L358">            holder.verbose = Validate.notNull(verbose, &quot;verbose&quot;);</span>
<span class="fc" id="L359">            return this;</span>
        }

        public Builder fmd(final FreeMarkerDown fmd) {
<span class="fc" id="L363">            holder.fmd = Validate.notNull(fmd, &quot;fmd&quot;);</span>
<span class="fc" id="L364">            return this;</span>
        }

        public Builder version(final Version version) {
<span class="fc" id="L368">            holder.version = Validate.notNull(version, &quot;version&quot;);</span>
<span class="fc" id="L369">            return this;</span>
        }

        /**
         * Creates the final product.
         *
         * @return never {@code null}, always new instance
         */
        public JUberblog product() {
<span class="fc" id="L378">            return validate(holder.copy());</span>
        }

        /**
         * Validates that all fields are not {@code null}.
         *
         * @param product must not be {@code null}
         * @return the validated object itself
         */
        private JUberblog validate(final JUberblog product) {
<span class="fc" id="L388">            Validate.notNull(product, &quot;product&quot;);</span>
<span class="fc" id="L389">            notNull(product.cfg, &quot;Configuration must not be null! Call Builder#configuration(cfg) first.&quot;);</span>
<span class="fc" id="L390">            notNull(product.dirs, &quot;Directories must not be null! Call Builder#directories(dirs) first.&quot;);</span>
<span class="fc" id="L391">            notNull(product.io, &quot;I/O must not be null! Call Builder#io(io) first.&quot;);</span>
<span class="fc" id="L392">            notNull(product.opt, &quot;Options must not be null! Call Builder#options(opt) first.&quot;);</span>
<span class="fc" id="L393">            notNull(product.tpls, &quot;Templates must not be null! Call Builder#templates(tpls) first.&quot;);</span>
<span class="fc" id="L394">            return product;</span>
        }

        /**
         * Throws {@link NullPointerException} if passed in object is {@code null}.
         *
         * @param o may be {@code null}
         * @param msg the exception message
         */
        private void notNull(final Object o, final String msg) {
<span class="fc bfc" id="L404" title="All 2 branches covered.">            if (null == o) {</span>
<span class="fc" id="L405">                throw new NullPointerException(msg);</span>
            }
<span class="fc" id="L407">        }</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>