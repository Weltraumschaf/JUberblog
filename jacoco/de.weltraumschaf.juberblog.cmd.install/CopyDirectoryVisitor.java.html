<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CopyDirectoryVisitor.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JUberblog</a> &gt; <a href="index.source.html" class="el_package">de.weltraumschaf.juberblog.cmd.install</a> &gt; <span class="el_source">CopyDirectoryVisitor.java</span></div><h1>CopyDirectoryVisitor.java</h1><pre class="source lang-java linenums">package de.weltraumschaf.juberblog.cmd.install;

import de.weltraumschaf.commons.application.IO;
import de.weltraumschaf.commons.validate.Validate;
import java.io.IOException;
import java.nio.file.FileVisitResult;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.SimpleFileVisitor;
import java.nio.file.StandardCopyOption;
import java.nio.file.attribute.BasicFileAttributes;

/**
 * Visitor to copy the scaffold directory.
 *
 * @since 1.0.0
 * @author Sven Strittmatter
 */
final class CopyDirectoryVisitor extends SimpleFileVisitor&lt;Path&gt; {

    /**
     * Target directory.
     */
    private final Path targetDir;
    /**
     * Path prefix removed from package source file name.
     */
    private final String prefix;
    /**
     * Used for CLI IO.
     */
    private final IO io;
    /**
     * Whether to print verbose messages to IO.
     */
    private final boolean verbose;
    /**
     * File copy strategy.
     */
    private InstallationType strategy;

    /**
     * Dedicated constructor.
     *
     * @param targetDir must not be {@code null}, must be directory, must exist
     * @param prefixToStrip must not be {@code null}
     * @param io used for verbose out
     * @param verbose whether to be verbose or not
     * @param strategy must not be {@code null}
     */
    CopyDirectoryVisitor(
        final Path targetDir,
        final String prefixToStrip,
        final IO io,
        final boolean verbose,
        final InstallationType strategy) {
<span class="fc" id="L57">        super();</span>
<span class="fc" id="L58">        Validate.notNull(targetDir, &quot;targetDir&quot;);</span>

<span class="pc bpc" id="L60" title="1 of 2 branches missed.">        if (!Files.exists(targetDir)) {</span>
<span class="nc" id="L61">            throw new IllegalArgumentException(String.format(&quot;Target '%s' does not exists!&quot;, targetDir));</span>
        }

<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        if (!Files.isDirectory(targetDir)) {</span>
<span class="nc" id="L65">            throw new IllegalArgumentException(String.format(&quot;Target '%s' is not a directory!&quot;, targetDir));</span>
        }

<span class="fc" id="L68">        this.targetDir = targetDir;</span>
<span class="fc" id="L69">        this.prefix = Validate.notNull(prefixToStrip, &quot;prefixToStrip&quot;);</span>
<span class="fc" id="L70">        this.io = Validate.notNull(io);</span>
<span class="fc" id="L71">        this.verbose = verbose;</span>
<span class="fc" id="L72">        this.strategy = Validate.notNull(strategy);</span>
<span class="fc" id="L73">    }</span>

    @Override
    public FileVisitResult preVisitDirectory(final Path dir, final BasicFileAttributes attrs) throws IOException {
<span class="fc" id="L77">        final FileVisitResult result = super.preVisitDirectory(dir, attrs);</span>
<span class="fc" id="L78">        final String str = dir.toString() + &quot;/&quot;;</span>

<span class="fc bfc" id="L80" title="All 2 branches covered.">        if (str.equals(prefix)) {</span>
            // Do not create the root dir.
<span class="fc" id="L82">            return result;</span>
        }

<span class="fc" id="L85">        final Path target = targetDir.resolve(baseName(dir));</span>

<span class="fc bfc" id="L87" title="All 2 branches covered.">        if (!Files.exists(target)) {</span>
<span class="fc" id="L88">            println(String.format(&quot;Create directory %s&quot;, target));</span>
<span class="fc" id="L89">            Files.createDirectory(target);</span>
        }

<span class="fc" id="L92">        return result;</span>
    }

    @Override
    public FileVisitResult visitFile(final Path file, final BasicFileAttributes attrs) throws IOException {
<span class="fc" id="L97">        final FileVisitResult result = super.visitFile(file, attrs);</span>
<span class="fc" id="L98">        final Path target = targetDir.resolve(baseName(file));</span>

<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (Files.exists(target)) {</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">            if (strategy == InstallationType.OVERWRITE) {</span>
<span class="fc" id="L102">                println(String.format(&quot;Overwrite file %s ...&quot;, target));</span>
<span class="fc" id="L103">                Files.copy(file, target, StandardCopyOption.REPLACE_EXISTING);</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            } else if (strategy == InstallationType.BACKUP) {</span>
<span class="fc" id="L105">                println(String.format(&quot;Back up file %s ...&quot;, target));</span>
<span class="fc" id="L106">                Files.copy(target, targetDir.resolve(baseName(file) + &quot;.bak&quot;));</span>
<span class="fc" id="L107">                Files.copy(file, target, StandardCopyOption.REPLACE_EXISTING);</span>
            } else {
<span class="nc" id="L109">                throw new IllegalArgumentException(String.format(&quot;File '%s' already exists!&quot;, target));</span>
            }
        } else {
<span class="fc" id="L112">            println(String.format(&quot;Copy file %s to %s ...&quot;, file, target));</span>
<span class="fc" id="L113">            Files.copy(file, target);</span>
        }

<span class="fc" id="L116">        return result;</span>
    }

    /**
     * Strips prefix from given path.
     *
     * @param file must not be {@code null}
     * @return never {@code null}
     */
    String baseName(final Path file) {
<span class="fc" id="L126">        return Validate.notNull(file, &quot;file&quot;).toString().replace(prefix, &quot;&quot;);</span>
    }

    /**
     * Prints message only if {@link #verbose} is {@code true}.
     *
     * @param msg should not be {@code null} or empty
     */
    void println(final String msg) {
<span class="fc bfc" id="L135" title="All 2 branches covered.">        if (verbose) {</span>
<span class="fc" id="L136">            io.println(msg);</span>
        }
<span class="fc" id="L138">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>